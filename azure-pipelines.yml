jobs:
    - job: Linux
      pool:
          vmImage: 'ubuntu-16.04'
      steps:
          - script: |
              curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
              source $HOME/.cargo/env
              rustup target add x86_64-unknown-linux-musl
              sudo apt-get -qq install musl-tools
            displayName: install rustup

          - script: |
              source $HOME/.cargo/env
              make test
            displayName: run test

          - script: |
              source $HOME/.cargo/env
              make release_lnx
            displayName: release build

    - job: macOS
      pool:
          vmImage: 'macos-10.13'
      steps:
          - script: |
              curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
            displayName: install rustup

          - script: |
              source $HOME/.cargo/env
              make test
            displayName: run test

          - script: |
              source $HOME/.cargo/env
              make release_mac
            displayName: release build

    - job: Windows
      pool:
          vmImage: 'vs2017-win2016'
      steps:
          - script: |
              curl -sSf -o rustup-init.exe https://win.rustup.rs
              rustup-init.exe -y --default-toolchain stable
              set PATH=%PATH%;%USERPROFILE%\.cargo\bin
              echo '##vso[task.setvariable variable=PATH;]%PATH%;%USERPROFILE%\.cargo\bin'
            displayName: install rustup

          - script: make test
            displayName: run test

          - script: make release_win
            displayName: release build

